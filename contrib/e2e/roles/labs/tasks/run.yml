---
- name: Set solana validator and epoch info commands
  ansible.builtin.set_fact:
    labs_validator: "{{ labs_workdir }}/solana-validator"
    labs_epoch_cmd: "{{ labs_workdir }}/solana -ul epoch-info"

- name: Display epoch-info
  ansible.builtin.debug:
    var: labs_epoch_cmd

- name: Get vote account public key
  ansible.builtin.command: "{{ labs_workdir }}/solana-keygen pubkey {{ labs_keys_dir }}/vote.json"
  register: vote_account_result

- name: Set vote_account
  ansible.builtin.set_fact:
    vote_account: "{{ vote_account_result.stdout }}"

- name: Display vote_account
  ansible.builtin.debug:
    var: vote_account

- name: Run Genesis
  ansible.builtin.command: >
    {{ labs_validator }} 
    --identity {{ labs_keys_dir }}/id.json 
    --ledger {{ labs_ledger }} 
    --limit-ledger-size {{ labs_ledger_size }}
    --dynamic-port-range {{ labs_port_start }}-{{ labs_port_end }}
    --no-genesis-fetch 
    --no-snapshot-fetch 
    --no-poh-speed-test 
    --no-os-network-limits-test 
    --vote-account {{ vote_account }}
    --expected-shred-version {{ shred_version }} 
    --expected-genesis-hash {{ genesis_hash }} 
    --no-wait-for-vote-to-start-leader 
    --incremental-snapshots 
    --full-snapshot-interval-slots {{ labs_snapshot_interval }} 
    --rpc-port {{ labs_rpc_port }} 
    --gossip-port {{ labs_gossip_port }} 
    --gossip-host {{ labs_gossip_host }} 
    --full-rpc-api 
    --tpu-disable-quic 
    --tpu-enable-udp 
    --log {{ labs_ledger }}/validator.log
  async: 0
  poll: -1
  register: validator_output

- name: Print Validator PID
  ansible.builtin.debug:
    var: validator_output.pid
  when: validator_output.rc == 0

- name: Wait for snapshot
  ansible.builtin.shell: "{{ labs_epoch_cmd }} || true | grep -o -P '(?<=Slot:).*(?=Epoch:)' | xargs"
  register: slot
  until: slot_value.stdout | int > {{ labs_snapshot_interval }}
  retries: 100
  delay: 2
