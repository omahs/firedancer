---
- name: Set solana validator and epoch info commands
  ansible.builtin.set_fact:
    labs_validator: "{{ labs_bindir }}/solana-validator"
    labs_epoch_cmd: "{{ labs_bindir }}/solana -u http://{{ labs_gossip_host }}:{{ labs_rpc_port }} epoch-info"

- name: Copy labs bootstrap validator template to system
  ansible.builtin.template:
    src: labs_bootstrap_validator.service.j2
    dest: /etc/systemd/system/labs_bootstrap_validator.service
  become: yes

- name: Start labs service if not already running
  ansible.builtin.systemd:
    name: labs_bootstrap_validator  
    state: started
  become: yes

- name: Wait for snapshot
  ansible.builtin.shell: "{{ labs_epoch_cmd }} | grep -oP 'Slot: \\K\\d+'" 
  register: slot_value
  until: (slot_value.stdout | int) > labs_snapshot_interval
  retries: 100
  delay: 2
