---
- name: Create temporary directory
  ansible.builtin.file:
    state: directory
    path: "~/.fd_e2e_bin_tmp"
  register: fd_e2e_bin
  delegate_to: localhost
  run_once: true

# Create distribution working directory
- name: Create working directory
  ansible.builtin.file:
    path: "{{ workdir }}"
    state: directory
  when: inventory_hostname in groups[run_group]

# Copy binaries from build hosts to controller
- name: Fetch binaries from build host
  ansible.posix.synchronize:
    src: "{{ bin }}"
    dest: "{{ fd_e2e_bin.path }}/"
    mode: pull
    recursive: false
    rsync_opts:
      - "--exclude='*.d'"
      - "--exclude='*.rlib'"
      - "--exclude='*.so'"
      - "--no-dirs"
  when: inventory_hostname == build_host
  delegate_to: localhost

# Copy binaries from controller to run hosts
- name: Copy binary from build host
  ansible.posix.synchronize:
    src: "{{ fd_e2e_bin.path }}/"
    dest: "{{ workdir }}/"
    checksum: true
    rsync_opts:
      - "--exclude='*.d'"
      - "--exclude='*.rlib'"
      - "--exclude='*.so'"
  when: inventory_hostname in groups[run_group]
  delegate_to: localhost

- name: Delete temporary directory
  ansible.builtin.file:
    path: "{{ fd_e2e_bin.path }}"
    state: absent
  delegate_to: localhost
  run_once: true
